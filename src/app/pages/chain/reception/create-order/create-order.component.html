<ng-template hq-alerter></ng-template>
<div class="card">
  <div class="card-header">
    创建工单
    <input container="body" type="text" value="我的挂单 ({{suspendedOrders?.length}})" #pop="bs-popover" readonly placement="bottom"
      [popover]="popTemplate" class="pull-right btn btn-sm textInputBtn" style="margin-right: 105px;">
    <!--挂单列模板-->
    <template #popTemplate>
      <div class="list-group">
        <a *ngFor="let order of suspendedOrders" (click)="loadSuspendedOrderInfo($event, order, pop)" class="list-group-item list-group-item-action">
          <span class="mr-2">{{order.customerName}}</span> 
          <span class="mr-2">{{order.plateNo}} </span>
          <span class="mr-2">{{order.phone}}</span>
          <button class="ml-2 btn btn-sm btn-danger my-sm"><i class="fa fa-trash" aria-hidden="true"></i></button>
        </a>
      </div>
    </template>
  </div>

  <!--填写工单信息表单-->
  <div class="card-block">
    <form [formGroup]="workSheetForm" autocomplete="off" (ngSubmit)="onSerarch()">
      <!--工单基本筛选条件面板-->
      <div class="form-group row">
        <label for="plateNo" class="col-sm-1 col-form-label col-form-label-sm"><span class="asterisk mr-1">*</span>车牌号</label>
        <div class="col-sm-2">
          <input [hqTableTypeahead]="plateNotypeaheadSource" [columns]="typeaheadColumns" (onSelect)="plateNoOnSelect($event)" class="form-control form-control-sm" formControlName="plateNo" id="plateNo" type="text" required placeholder="请输入车牌号" />
        </div>
        <label for="customerName" class="col-sm-1 col-form-label col-form-label-sm"><span class="asterisk mr-1">*</span>车主</label>
        <div class="col-sm-2">
          <input [hqTableTypeahead]="customerNametypeaheadSource" [columns]="typeaheadColumns" (onSelect)="onCustomerNameSelect($event)" type="text" required class="form-control form-control-sm" formControlName="customerName"
            id="customerName" placeholder="输入字母 ll 测试">

        </div>
        <!--根据车主查询客户车辆信息下拉列表，自定义显示模板 let-model="item"遍历集合, 引用记录 -->
        <template #customCustomerVehicleTemplate let-model="item" let-index="index">
          车主: {{model?.customerName}} -- 车牌号: {{ model?.plateNo }}
        </template>
        <label for="phone" class="col-sm-1 col-form-label col-form-label-sm">车主电话</label>
        <div class="col-sm-2">
          <input type="text" class="form-control form-control-sm" formControlName="phone" id="phone" placeholder="车主电话">
        </div>
      </div>
      <hr>
      <div class="form-group row">
        <label for="createdOnUtc" class="col-sm-1 col-form-label col-form-label-sm">开单时间</label>
        <div class="col-sm-2">
          <input type="text" class="form-control form-control-sm" formControlName="createdOnUtc" id="createdOnUtc">
        </div>
        <label for="contactUser" class="col-sm-1 col-form-label col-form-label-sm"><span class="asterisk mr-1">*</span>送修人</label>
        <div class="col-sm-2">
          <input type="text" required class="form-control form-control-sm" formControlName="contactUser" id="contactUser" placeholder="送修人">
        </div>
        <label for="contactInfo" class="col-sm-1 col-form-label col-form-label-sm"><span class="asterisk mr-1">*</span>送修人电话</label>
        <div class="col-sm-2">
          <input required type="text" class="form-control form-control-sm" formControlName="contactInfo" id="contactInfo" placeholder="送修人电话">
        </div>
        <label for="createdUserName" class="col-sm-1 col-form-label col-form-label-sm">服务顾问</label>
        <div class="col-sm-2">
          <input type="text" class="form-control form-control-sm" formControlName="createdUserName" id="createdUserName">
        </div>
      </div>
      <div class="form-group row">
        <label for="introducer" class="col-sm-1 col-form-label col-form-label-sm">介绍人</label>
        <div class="col-sm-2">
          <input type="text" class="form-control form-control-sm" formControlName="introducer" id="introducer" placeholder="介绍人">
        </div>
        <label for="introPhone" class="col-sm-1 col-form-label col-form-label-sm">介绍人电话</label>
        <div class="col-sm-2">
          <input type="text" class="form-control form-control-sm" formControlName="introPhone" id="introPhone" placeholder="介绍人电话">
        </div>
        <label for="brand" class="col-sm-1 col-form-label col-form-label-sm"><span class="asterisk mr-1">*</span>品牌</label>
        <div class="col-sm-2">
          <input (typeaheadOnSelect)="onBrandSelect($event)" [typeahead]="brandDataSource" typeaheadOptionField="name" required type="text"
            class="form-control form-control-sm" formControlName="brand" id="brand" placeholder="输入 奥迪/大众  测试">
        </div>
        <label for="series" class="col-sm-1 col-form-label col-form-label-sm"><span class="asterisk mr-1">*</span>车系</label>
        <div class="col-sm-2">
          <input (typeaheadOnSelect)="onSeriesSelect($event)" [typeahead]="seriesDataSource" typeaheadOptionField="name" required type="text"
            class="form-control form-control-sm" formControlName="series" id="series" placeholder="输入 奥迪/大众  测试">
        </div>
      </div>
      <div class="form-group row">
        <label for="model" class="col-sm-1 col-form-label col-form-label-sm"><span class="asterisk mr-1">*</span>车型</label>
        <div class="col-sm-2">
          <input (typeaheadOnSelect)="onModelSelect($event)" [typeahead]="modelDataSource" typeaheadOptionField="name" required type="text"
            class="form-control form-control-sm" formControlName="model" id="model" placeholder="输入 加长 测试">
        </div>
        <label for="vin" class="col-sm-1 col-form-label col-form-label-sm"><span class="asterisk mr-1">*</span>VIN</label>
        <div class="col-sm-2">
          <input type="text" class="form-control form-control-sm" formControlName="vin" id="vin" placeholder="VIN">
        </div>
        <label for="validate" class="col-sm-1 col-form-label col-form-label-sm">验车日期</label>
        <div class="input-group input-group-sm col-sm-2">
          <input class="form-control form-control-sm datetime-picker" type="text" formControlName="validate" ngui-datetime-picker date-format="YYYY-MM-DD"
            date-only="true" />
          <span class="input-group-addon">
            <i class="fa fa-calendar" aria-hidden="true"></i>
          </span>
        </div>
      </div>
      <hr>
      <div class="form-group row">
        <label for="type" class="col-sm-1 col-form-label col-form-label-sm"><span class="asterisk mr-1">*</span>维修类型</label>
        <div class="col-sm-2">
          <select required id="type" formControlName="type" class="form-control sm">
            <option *ngFor="let type of maintenanceTypeData" value="{{type.id}}">{{type.value}}</option>
          </select>
        </div>
        <label for="expectLeave" class="col-sm-1 col-form-label col-form-label-sm"><span class="asterisk mr-1">*</span>预计交车时间</label>
        <div class="input-group input-group-sm col-sm-2">
          <input class="form-control form-control-sm datetime-picker" type="text" formControlName="expectLeave" ngui-datetime-picker
            date-format="YYYY-MM-DD hh:mm" hour="23" minute='59' />
          <span class="input-group-addon">
                <i class="fa fa-calendar" aria-hidden="true"></i>
              </span>
        </div>
        <label for="mileage" class="col-sm-1 col-form-label col-form-label-sm"><span class="asterisk mr-1">*</span>行驶里程</label>
        <div class="input-group input-group-sm col-sm-2">
          <input required type="text" class="form-control form-control-sm" formControlName="mileage" id="mileage">
          <span class="input-group-addon"><i>KM</i></span>
        </div>
        <label for="lastEnter" class="col-sm-1 col-form-label col-form-label-sm">上次进店时间</label>
        <div class="col-sm-2">
          <input type="text" class="form-control form-control-sm" formControlName="lastEnter" id="lastEnter">
        </div>
      </div>
      <div class="form-group row">

        <label for="nextDate" class="col-sm-1 col-form-label col-form-label-sm">建议下次保养日期</label>
        <div class="input-group input-group-sm col-sm-2">
          <input class="form-control form-control-sm datetime-picker" type="text" formControlName="nextDate" ngui-datetime-picker date-format="YYYY-MM-DD"
            date-only="true" />
          <span class="input-group-addon">
                <i class="fa fa-calendar" aria-hidden="true"></i>
              </span>
        </div>
        <label for="location" class="col-sm-1 col-form-label col-form-label-sm">维修工位</label>
        <div class="col-sm-2">
          <input type="text" class="form-control form-control-sm" formControlName="location" id="location">
        </div>
        <label for="lastMileage" class="col-sm-1 col-form-label col-form-label-sm">上次进店里程</label>
        <div class="input-group input-group-sm col-sm-2">
          <input type="text" class="form-control form-control-sm" formControlName="lastMileage" id="lastMileage">
          <span class="input-group-addon"><i>KM</i></span>
        </div>
        <label for="nextMileage" class="col-sm-1 col-form-label col-form-label-sm">建议下次保养里程</label>
        <div class="input-group input-group-sm col-sm-2">
          <input type="text" class="form-control form-control-sm" formControlName="nextMileage" id="nextMileage">
          <span class="input-group-addon"><i>KM</i></span>
        </div>
      </div>
    </form>
    <hr>

    <tabset>
      <tab heading="维修项目">
        <table class="table table-hover table-bordered table-sm">
          <thead>
            <tr>
              <th>操作</th>
              <th>维修项目名称</th>
              <th>维修工时(小时)</th>
              <th>工时单价(元)</th>
              <th>折扣率(%)</th>
              <th>金额(元)</th>
              <th>操作时间</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let item of newMaintenanceItemData2">
              <td width="40">
                <a href="#" (click)="onDelNewMaintenanceItem($event, item.serviceId)">删除</a>
              </td>
              <td>{{item.serviceName}}</td>
              <td>{{item.workHour}}</td>
              <td>{{item.price}}</td>
              <td>{{item.discount}}</td>
              <td>{{item.amount/100}}</td>
              <td>{{item.operationTime}}</td>
            </tr>
            <tr *ngIf="addNewMaintenanceItem">
              <td width="75">
                <a href="#" (click)="onConfirmAddNewMaintenanceItem($event)">确定</a> |
                <a href="#" (click)="addNewMaintenanceItem = false">取消</a>
              </td>
              <td><input placeholder="输入 更换  进行测试" (blur)="onServiceBlur()" (change)="onServiceChange()" [hqTableTypeahead]="serviceNametypeaheadSource" [columns]="serviceNameTypeaheadColumns" (onSelect)="serviceTypeaheadOnSelect($event)"  [(ngModel)]="newMaintenanceItem.serviceName"
                  type="text" class="form-control form-control-sm" required></td>
              <td><input placeholder="请输入数字" (keyup.enter)="onConfirmAddNewMaintenanceItem()" [(ngModel)]="newMaintenanceItem.workHour"
                  (keyup)="onWorkHourChange()" type="text" class="form-control form-control-sm" required></td>
              <td><input placeholder="请输入数字" (keyup.enter)="onConfirmAddNewMaintenanceItem()" [(ngModel)]="newMaintenanceItem.price"
                  (keyup)="onPriceChange()" type="text" class="form-control form-control-sm" required></td>
              <td><input placeholder="请输入0~100之间的整数" (keyup.enter)="onConfirmAddNewMaintenanceItem()" [(ngModel)]="newMaintenanceItem.discount"
                  (keyup)="onDiscountChange()" type="text" class="form-control form-control-sm" required></td>
              <td><input [value]="newMaintenanceItem.amount/100" type="text" class="form-control form-control-sm" [disabled]="true"></td>
              <td><input [value]="newMaintenanceItem.operationTime" type="text" class="form-control form-control-sm" [disabled]="true"></td>
            </tr>
          </tbody>
        </table>
        <div>
          <button class="btn btn-sm btn-secondary mr-2" (click)="addNewmaintanceItem2()" placement="right">新增</button>
        </div>
      </tab>
      <tab heading="上次维修记录">
        <table class="table table-hover table-bordered table-sm">
          <caption>维修项目</caption>
          <thead>
            <tr>
              <th>项目名称</th>
              <th>维修工时</th>
              <th>工时单价(元)</th>
              <th>金额(元)</th>
              <th>折扣率</th>
              <th>操作时间</th>
              <th>操作员</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let record of lastOrderData?.serviceOutputs">
              <td>{{record?.name}}</td>
              <td>{{record?.workingHour }}</td>
              <td>{{record?.price}}</td>
              <td>{{record?.workingHour * record?.price}}</td>
              <td>{{record?.discount}}</td>
              <td>{{record?.operateDateTime}}</td>
              <td>{{user.username}}</td>
            </tr>
          </tbody>
        </table>
        <br>
        <table class="table table-hover table-bordered table-sm">
          <caption>维修配件</caption>
          <thead>
            <tr>
              <th>维修工项</th>
              <th>配件名称</th>
              <th>品牌</th>
              <th>规格型号</th>
              <th>数量</th>
              <th>单价(元)</th>
              <th>金额(元)</th>
              <th>操作时间</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let record of lastOrderData?.productOutputs">
              <td>{{record?.serviceName}}</td>
              <td>{{record?.productName}}</td>
              <td>{{record?.brandName}}</td>
              <td>{{record?.specification}}</td>
              <td>{{record?.count}}</td>
              <td>{{record?.price}}</td>
              <td>{{record?.price * record?.count}}</td>
              <td>{{record?.operateDateTime|date:"yyyy/MM/dd HH:mm:ss"}}</td>
            </tr>
          </tbody>
        </table>
        <br>
        <table class="table table-hover table-bordered table-sm">
          <caption>附加项目</caption>
          <thead>
            <tr>
              <th>备注</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let record of lastOrderData?.attachServiceOutputs">
              <td>{{record?.description}}</td>
            </tr>
          </tbody>
        </table>
        <br>
        <table class="table table-hover table-bordered table-sm">
          <caption>建议维修项目</caption>
          <thead>
            <tr>
              <th>建议维修项目</th>
              <th>操作时间</th>
              <th>备注</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let record of lastOrderData?.SuggestServiceDetailOutput">
              <td>{{record?.content}}</td>
              <td>{{record?.operateDateTime|date:"yyyy/MM/dd HH:mm:ss"}}</td>
              <td>{{record?.description}}</td>
            </tr>
          </tbody>
        </table>
      </tab>
      <br>
      <!--只有前4个选项卡显示-->
      <div *ngIf="true" class="card">
        <div class="card-header" style="font-size:smaller;color:gray;padding: 3px 5px;">
          折前费用: 工时费
          <span class="ml-2 mr-2">{{fee.workHour}}</span> | 材料费
          <span class="ml-2 mr-2">{{fee.material}}</span> | 其它
          <span class="ml-2 mr-2">{{fee.other}}</span> | 合计
          <span class="ml-2 mr-2">{{fee.workHour+fee.material+fee.other}}</span>|
        </div>
        <div class="card-block text-center">
          <input type="text" class="btn textInputBtn" readonly [disabled]="!enableCreateWorkSheet" (click)="createWorkSheet()" value="生成工单">
          <input type="text" class="btn textInputBtn" readonly [disabled]="!enableSuspendWorkSheet" (click)="suspendOrder()" value="挂单">
        </div>
      </div>
    </tabset>
  </div>