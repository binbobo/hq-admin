<div class="bill card">
  <div class="card-header">
    <span>结算单</span>
  </div>
  
  <div class='card-block'>
    <form (ngSubmit)="onSearch()">
      <div class="form-group">
        <div class="form-check form-check-inline" *ngFor="let status of orderStatusData">
          <label class="form-check-label">
            <input (change)='status.checked = !status.checked' [checked]="status.checked" class="form-check-input"  type="checkbox" value="{{status.id}}"> {{status.value}}
          </label>
        </div>
      </div>
      <div class="form-group row">
        <label for="serviceId">工单号：</label>
        <div class="col-sm-2">
          <input type="text" [(ngModel)]="params.billcode" class="form-control" id="billcode" name="billcode" placeholder="工单号">
        </div>
        <label for="plateNo">车牌号：</label>
        <div class="col-sm-2">
          <input type="text" [(ngModel)]="params.carnumber" class="form-control" id="carnumber" name="carnumber" placeholder="车牌号">
        </div>
        <label for="createdTime">进店时间：</label>
        <div class="col-sm-2">
          <input class="form-control datetime-picker" [(ngModel)]="params.starttime" id="starttime" name="starttime" type="text" ngui-datetime-picker
            date-format="YYYY-MM-DD" date-only="true" />
        </div>
        至：
        <div class="col-sm-2">
          <input class="form-control  datetime-picker" id="endtime" [(ngModel)]="params.endtime" name="endtime" type="text" ngui-datetime-picker
            date-format="YYYY-MM-DD" date-only="true" />
        </div>
      </div>
      <div class="form-group row">
        <label for="SettlementCode">结算单号：</label> 
        <div class="col-sm-2">
          <input class="form-control" [(ngModel)]="params.SettlementCode" id="SettlementCode" name="SettlementCode" type="text" placeholder="结算单号"
          />
        </div> 
        <div class="col-sm-2"><button class="btn btn-primary">查询</button></div>
      </div>
    </form>
    <div class="table-container">
      <table class='table table-striped table-bordered'>
        <thead class="">
          <tr>
            <th>操作</th>
            <th>状态</th>
            <th>车牌号</th>
            <th>结算单号</th>
            <th>工单号</th>
            <th>应收金额</th>
            <th>维修类型</th>
            <th>开单时间</th>
            <th>预计交车时间</th>
            <th>车型</th>
            <th>送修人</th>
            <th>服务顾问</th>
            <th>结算时间</th>
          </tr>
        </thead>
        <tbody>

          <tr *ngFor="let item of list">
            <td *ngIf="!item.updateOnUtc" style="text-align:right"><button type="button" class="btn btn-sm btn-primary" [hqSpinner]="item.generat" [disabled]="item.generat" (click)='orderDetailsDialog($event, item.id,lgModal,item)'>结算</button>&nbsp;
              <button [hqSpinner]="item.generating" type="button" class="btn btn-sm btn-info" [disabled]="item.generating" (click)='DetailsDialog($event, item.id,lgModal,item)'>详情</button>
            </td>
            <td *ngIf="item.updateOnUtc" style="text-align:right"><button type="button" class="btn btn-sm btn-danger" (click)='finishedOrder($event, item.id, confirmModal)'>撤销结算</button>&nbsp;
              <button [hqSpinner]="item.generating" type="button" class="btn btn-sm btn-info" [disabled]="item.generating" (click)='DetailsDialog($event, item.id,lgModal,item)'>详情</button>
            </td>
            <td>{{item.statusName}}</td>
            <td>{{item.plateNo}}</td>
            <td>{{item?.settlementCode}}</td>
            <td>{{item.billCode}}</td>
            <td>{{item.amount|centToYuan}}</td>
            <td>{{item.typeName}}</td>
            <td>{{item.createdOnUtc|date:"yyyy/MM/dd HH:mm:ss"}}</td>
            <td>{{item.expectLeave|date:"yyyy/MM/dd HH:mm:ss"}}</td>
            <td>{{item.model}}</td>
            <td>{{item.customerName}}</td>
            <td>{{item.createdUserName}}</td>
            <td>{{item.updateOnUtc|date:"yyyy/MM/dd HH:mm:ss"}}</td>

          </tr>
        </tbody>
      </table>
    </div>
    <hq-pagination [loading]="loading" [totalItems]="total" [(currentPage)]="index" (pageChanged)="onPageChanged($event)"></hq-pagination>
  </div>

  <!--提示是否确认退出-->
  <div bsModal #confirmModal="bs-modal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="mySmallModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-sm">
      <div class="modal-content">
        <div class="modal-header">
          <p class="modal-title">温馨提示</p>
          <button type="button" class="close pull-right" aria-label="Close" (click)="confirmModal.hide();">
          <span aria-hidden="true">&times;</span>
        </button>
        </div>
        <div class="modal-body">
          <p>您确定要撤销结算吗</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" data-dismiss="modal" (click)="unBill(confirmModal);">确定</button>
          <button type="button" class="btn btn-secondary" data-dismiss="confirmModal" (click)="confirmModal.hide();">取消</button>

        </div>
      </div>
    </div>
  </div>
</div>
<!--详情 begin-->
<div bsModal #lgModal="bs-modal" class="modal fade" tabindex="-1" role="dialog">
  <div *ngIf="lgModal.isShown" class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header pos-top">
        <button type="button" class="btn btn-secondary pull-left" aria-label="Close" [hidden]="!isShowPrint" (click)='print()'>打印</button>
        <button type="button" class="close pull-right" (click)="hideModal(lgModal)" aria-label="Close">
          <span aria-hidden="true" class="pull-right close-right">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <!--导出详情begin-->

        <!--工单详情 start-->
        <ng-template hq-alerter></ng-template>
        <hq-workorder-detail [data]="selectedOrder"></hq-workorder-detail>

        <!--结算费用-->
        <div class="card" [hidden]="!isShowCost" *ngIf="lgModal.isShown">
          <div class="card-header" style="font-size:smaller;color:gray;padding: 3px 5px;padding-left: 28px;">
            工时费：
            <span class="ml-2 mr-2">{{workHourFee|centToYuan}}元</span> | 材料费：
            <span class="ml-2 mr-2">{{materialFee|centToYuan}}元</span> | 优惠：
            <span class="ml-2 mr-2">元</span> | 应收金额:
            <span class="ml-2 mr-2">{{sumFee|centToYuan}}元</span>
          </div>
          <div class="card-header">
            <span class="ml-2 mr-2">应收金额(元)：
                <input type="number"   [(ngModel)]="billPrice"></span>
            <span class="ml-2 mr-2">出厂里程(KM)：
                <input type="number"  [(ngModel)]="leaveMileage"></span>
            <button type="button" [hqSpinner]="generat" class="btn btn-primary" aria-label="Close" (click)="BillClick($event,lgModal)">确定</button>
          </div>
        </div>
        <!--详情费用-->
        <div class="card" [hidden]="!isShowCostDetail" *ngIf="lgModal.isShown">
          <div class="card-header" style="font-size:smaller;color:gray;padding: 3px 5px;">
            工时费
            <span class="ml-2 mr-2">{{workHourFee|centToYuan}}元</span> | 材料费
            <span class="ml-2 mr-2">{{materialFee|centToYuan}}元</span> | 优惠：
            <span class="ml-2 mr-2">元</span> | 应收金额：
            <span class="ml-2 mr-2">{{sumFee|centToYuan}}元</span>
          </div>
        </div>
        <!--建议维修项 end-->
        <!--导出详情end-->
      </div>
    </div>
  </div>
</div>
<!--详情 end-->

<hq-print-order *ngIf="printData" [hidden]="true" [data]="printData" hqPrint #printer="hq-print"></hq-print-order>