<ng-template hq-alerter></ng-template>
<div class="card append-order">
  <div class="card-header">
    <span>增项</span>
    <!--<span class="tooltipp">zegnxiang</span>-->
    <ng-template hqSuspendBill="MWIM" (onSelect)="onSuspendSelect($event)" [columns]="columns"></ng-template>
  </div>
  <div class="card-block">
    <div>
      <form class='form-in serach-input'>
        <input [hqTableTypeahead]="typeaheadSource" [(ngModel)]="initValue" name="initValue" [columns]="typeaheadColumns" (onSelect)="onTypeaheadSelect($event)"
          class="form-control" placeholder="请输入工单号/车牌号" />
      </form>
    </div>
    <table class="table table-order-info table-bordered">
      <thead>
        <tr>
          <th colspan="4" class="tr-left-bold">车辆信息</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>工单号</td>
          <td>{{SearchappendList.billCode}}</td>
          <td>车牌号</td>
          <td>{{SearchappendList.plateNo}}</td>
        </tr>
        <tr>
          <td>车主</td>
          <td>{{SearchappendList.customerName}} </td>
          <td>车主电话</td>
          <td>{{SearchappendList.phone}} </td>
        </tr>
        <tr>
          <td>送修人</td>
          <td>{{SearchappendList.contactUser}}</td>
          <td>送修人电话</td>
          <td>{{SearchappendList.contactInfo}}</td>
        </tr>
        <tr>
          <td>介绍人</td>
          <td>{{SearchappendList.introducer}} </td>
          <td>介绍人电话</td>
          <td>{{SearchappendList.introPhone}}</td>
        </tr>
        <tr>
          <td>品牌</td>
          <td>{{SearchappendList.brand}}</td>
          <td>车系</td>
          <td>{{SearchappendList.series}}</td>
        </tr>
        <tr>
          <td>车型</td>
          <td>{{SearchappendList.vehicleName}}</td>
          <td>VIN</td>
          <td>{{SearchappendList.vin}}</td>
        </tr>
        <tr>
          <td>维修类型</td>
          <td>{{SearchappendList.typeName}}</td>
          <td>验车日期</td>
          <td>{{SearchappendList.validate |sDatetime}}</td>
        </tr>
        <tr>
          <td>预计交车时间</td>
          <td>{{SearchappendList.expectLeave|sDatetime}}</td>
          <td>进厂里程(KM)</td>
          <td>{{SearchappendList.mileage}}</td>
        </tr>
        <tr>
          <td>上次进厂时间</td>
          <td>{{SearchappendList.lastEnterDate|sDatetime}}</td>
          <td>上次进厂里程(KM)</td>
          <td>{{SearchappendList.lastMileage}}</td>
        </tr>
        <tr>
          <td>建议下次保养日期</td>
          <td>{{SearchappendList.nextDate|sDatetime}}</td>
          <td>建议下次保养里程(KM)</td>
          <td>{{SearchappendList.nextMileage}}</td>
        </tr>
        <tr>
          <td>维修工位</td>
          <td>{{SearchappendList.location}}</td>
          <td></td>
          <td></td>
        </tr>
      </tbody>
    </table>



    <div [hidden]="!isShowAppend">
      <tabset #staticTabs>
        <!--维修项目-->
        <tab heading="维修项目">

          <div class="table-container">
            <table class="table  table-bordered">
              <thead>
                <tr>
                  <th>操作</th>
                  <th>维修项目名称</th>
                  <th>维修工时(小时)</th>
                  <th>工时单价(元)</th>
                  <th>折扣率(%)</th>
                  <th>金额(元)</th>
                  <!--<th>操作时间</th>-->

                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let item of maintenanceProjectData">
                  <td>&nbsp;</td>
                  <td>{{item.serviceName}}<span *ngIf="item.type === 3" class="append-stamp">增项</span></td>
                  <td>{{item.workHour}}</td>
                  <td>{{item.price|centToYuan}}</td>
                  <td>{{item.discount}}</td>
                  <td>{{item.amount|centToYuan}}</td>
                  <!--<td>{{item.operateDateTime|sDatetime}}</td>-->
                </tr>

                <tr *ngFor="let item of newMaintenanceItemData">
                  <td width="40">
                    <button class="btn btn-sm btn-success mr-2" (click)="onMaintenanceItemEdit($event, addModal, item)">编辑</button>
                    <button class="btn btn-sm btn-danger mr-2" (click)="$event.preventDefault();onDelMaintenanceItem(item?.serviceId)">删除</button>
                  </td>
                  <td>{{item?.serviceName}}</td>
                  <td>{{item?.workHour}}</td>
                  <td>{{item?.price|centToYuan}}</td>
                  <td>{{item?.discount}}</td>
                  <td>{{item?.amount|centToYuan}}</td>
                  <td>{{item?.operationTime|sDatetime}}</td>
                </tr>
              </tbody>
            </table>
          </div>
          <div>
            <button class="btn btn-sm btn-info mr-2" (click)="addModal.show()" placement="right">新增</button>
          </div>
        </tab>
        <!--附加项目-->

        <tab heading="附加项目">
          <div class="table-container">
            <table class='table   table-bordered'>
              <thead>
                <tr>
                  <th>操作</th>
                  <th>备注</th>
                </tr>
              </thead>
              <tr *ngFor="let item of attachServiceOutputs">
                <td></td>
                <td>{{item.description}}</td>
              </tr>
              <tr *ngFor="let item of newAttachData;let i=index">
                <td width="40">
                  <button class="btn btn-sm btn-success mr-2" (click)="onAttachEdit($event, attachModal, item)">编辑</button>
                  <button class="btn btn-sm btn-danger mr-2" (click)="$event.preventDefault();onDelAttachItem(i)">删除</button>
                </td>
                <td>{{item.description}}</td>
              </tr>
            </table>
          </div>
          <div>
            <button class="btn btn-sm btn-info mr-2" [disabled]="!!((newAttachData?.length)>=1)" (click)="attachModal.show()" placement="right">新增</button>
          </div>
        </tab>

        <!--建议维修项-->
        <tab heading="建议维修项">
          <div class="table-container">
            <table class='table  table-bordered'>
              <thead>
                <tr>
                  <th>操作</th>
                  <th>建议维修项目</th>
                  <!--<th>操作时间</th>-->
                  <th>备注</th>

                </tr>
              </thead>
              <tr *ngFor="let item of suggestServiceOutputs">
                <td></td>
                <td>{{item.content}}</td>
                <!--<td>{{item.operateDateTime|sDatetime}}</td>-->
                <td>{{item.description}}</td>

              </tr>
              <tr *ngFor="let item of newSuggestData">
                <td width="40">
                  <button class="btn btn-sm btn-success mr-2" (click)="onSuggestItemEdit($event, suggestModal, item)">编辑</button>
                  <button class="btn btn-sm btn-danger mr-2" (click)="$event.preventDefault();onDelSuggestItem(item.serviceId)">删除</button>
                </td>
                <td>{{item.serviceName}}</td>
                <td>{{item.operationTime|sDatetime}}</td>
                <td>{{item.description}}</td>

              </tr>

            </table>
          </div>
          <div>
            <button class="btn btn-sm btn-info mr-2" (click)="suggestModal.show()" placement="right">新增</button>
          </div>
        </tab>

        <!--上次维修记录-->
        <tab heading="上次维修记录" *ngIf="lastManufactureDetailOutput">
          <div class="table-container">
            <table class="table  table-bordered">
              <caption>维修项目</caption>
              <thead>
                <tr>
                  <th>项目名称</th>
                  <th>维修工时(小时)</th>
                  <th>工时单价(元)</th>
                  <th>金额(元)</th>
                  <th>折扣率(100%)</th>
                  <!--<th>操作时间</th>-->

                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let item of lastDataProjectList ">
                  <td>{{item.serviceName}}<span [class.append-stamp]="item.type === 3">增项</span></td>
                  <td>{{item.workHour}}</td>
                  <td>{{item.price|centToYuan}}</td>
                  <td>{{item.amount|centToYuan}}</td>
                  <td>{{item.discount}}</td>
                  <!--<td>{{item.operateDateTime|sDatetime}}</td>-->

                </tr>
              </tbody>
            </table>

          </div>
          <div class="table-container">
            <table class="table table-bordered">
              <caption>维修配件</caption>
              <thead>
                <tr>
                  <th>维修工项</th>
                  <th>配件编码</th>
                  <th>配件名称</th>
                  <th>品牌</th>
                  <th>规格型号</th>
                  <th>数量(个)</th>
                  <th>单价(元)</th>
                  <th>金额(元)</th>
                  <!--<th>操作时间</th>-->
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let item of lastRepairList">
                  <td>{{item.serviceName}}</td>
                  <td>{{item.productCode}}</td>
                  <td>{{item.productName}}</td>
                  <td>{{item.brandName}}</td>
                  <td>{{item.specification}}</td>
                  <td>{{item.count}}</td>
                  <td>{{item.price|centToYuan}}</td>
                  <td>{{item.amount|centToYuan}}</td>
                  <!--<td>{{item.operateDateTime|sDatetime}}</td>-->
                </tr>
              </tbody>
            </table>
          </div>
          <div class="table-container">
            <table class="table  table-bordered">
              <caption>附加项目</caption>
              <thead>
                <tr>
                  <th>备注</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let item of lastAddList">
                  <td>{{item.description}}</td>
                </tr>
              </tbody>
            </table>
          </div>
          <div class="table-container">
            <table class="table   table-bordered">
              <caption>建议维修项目</caption>
              <thead>
                <tr>
                  <th>建议维修项目</th>
                  <!--<th>操作时间</th>-->
                  <th>备注</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let item of lastSuggestList">
                  <td>{{item.content}}</td>
                  <!--<td>{{item.operateDateTime|sDatetime}}</td>-->
                  <td>{{item.description}}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </tab>
      </tabset>

      <div class="card" style="margin-top:40px;">
        <div class="card-header" style="font-size:smaller;color:gray;padding: 3px 5px;">
          工时费：<span class="ml-2 mr-2">{{workHourFee|centToYuan}}元</span> | 材料费：
          <span class="ml-2 mr-2">{{materialFee|centToYuan}}元</span> | 优惠：
          <span class="ml-2 mr-2">{{(workHourFee-sumFee)|centToYuan}}元</span> | 应收金额：
          <span class="ml-2 mr-2">{{(workHourFee+materialFee)|centToYuan}}元</span>
        </div>
      </div>

    </div>

  </div>
  <div class="card-footer text-muted">
    <button type="button" class="btn btn-primary" [disabled]="!isableAppend" (click)="submitAddOrder()">提交增项</button>
    <button type="button" class="btn btn-success" [disabled]="!isableSuspend" (click)="suspend()">挂单</button>
  </div>

</div>

<div bsModal #addModal="bs-modal" class="modal" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true">
  <!--每次都创建一个新的 为了清空表单-->
  <div *ngIf="addModal.isShown" class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h6 class="modal-title pull-left">新增维修项目</h6>
        <button type="button" class="close pull-right" (click)="addModal.hide();selectedItem=null;" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <hq-add-maintenance-item [services]="selectedServices" [item]="selectedItem" (onCancel)="addModal.hide();selectedItem=null;"
          (onConfirm)="onConfirmNewMaintenanceItem($event, addModal)"></hq-add-maintenance-item>
      </div>
    </div>
  </div>
</div>

<div bsModal #attachModal="bs-modal" class="modal" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true">
  <!--每次都创建一个新的 为了清空表单-->
  <div *ngIf="attachModal.isShown" class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h6 class="modal-title pull-left">新增附加项目</h6>
        <button type="button" class="close pull-right" (click)="attachModal.hide();selectedAttachItem=null;" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <hq-add-attach-item (onCancel)="attachModal.hide();selectedAttachItem=null" [item]="selectedAttachItem" (formSubmit)="onCreateAttach($event)"></hq-add-attach-item>
      </div>
    </div>
  </div>
</div>

<div bsModal #suggestModal="bs-modal" class="modal" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true">
  <!--每次都创建一个新的 为了清空表单-->
  <div *ngIf="suggestModal.isShown" class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h6 class="modal-title pull-left">新增建议维修项目</h6>
        <button type="button" class="close pull-right" (click)="suggestModal.hide();selectedSuggestItem=null;" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">

        <hq-add-suggest-item [services]="selectedSuggestServices" [item]="selectedSuggestItem" (onCancel)="suggestModal.hide();selectedSuggestItem=null;"
          (onConfirm)="onConfirmNewSuggestItem($event, suggestModal)"></hq-add-suggest-item>
      </div>
    </div>
  </div>
</div>