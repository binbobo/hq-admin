<ng-template hq-alerter></ng-template>
<div class="card append-order">
  <div class="card-header">
    <span>增项</span>
    <!--<span class="tooltipp">zegnxiang</span>-->
    <ng-template hqSuspendBill="MWIM" (onSelect)="onSuspendSelect($event)" [columns]="columns"></ng-template>
  </div>
  <div class="card-block">
    <div>
      <form [formGroup]="myForm" class='form-in serach-input'>
        <input [hqTableTypeahead]="typeaheadSource" [columns]="typeaheadColumns" (onSelect)="onTypeaheadSelect($event)" class="form-control"
          placeholder="请输入工单号/车牌号" />
      </form>
    </div>
    <div class="serach-main">
      <div class="serach-list">工单号:{{SearchappendList.billCode}}</div>
      <div class="serach-list"> </div>
      <div class="serach-list"> </div>
      <div class="serach-list"> </div>
    </div>
    <div class="serach-main">
      <div class="serach-list">车牌号:{{SearchappendList.plateNo}}</div>
      <div class="serach-list">车主:{{SearchappendList.customerName}} </div>
      <div class="serach-list">车主电话:{{SearchappendList.phone}} </div>
      <div class="serach-list">验车时间:{{SearchappendList.validate |sDatetime}} </div>
    </div>
    <div class="serach-main">
      <div class="serach-list">开单时间:{{SearchappendList.createdOnUtc |sDatetime}} </div>
      <div class="serach-list">送修人:{{SearchappendList.contactUser}} </div>
      <div class="serach-list">送修人电话:{{SearchappendList.contactInfo}}</div>
      <div class="serach-list">服务顾问:{{SearchappendList.createdUserName}}</div>
    </div>
    <div class="serach-main">
      <div class="serach-list">品牌:{{SearchappendList.brand}} </div>
      <div class="serach-list">车系:{{SearchappendList.series}}</div>
      <div class="serach-list">车型:{{SearchappendList.vehicleName}}</div>
      <div class="serach-list">VIN:{{SearchappendList.vin}}</div>
    </div>
    <div class="serach-main">
      <div class="serach-list">维修类型:{{SearchappendList.typeName}}</div>
      <div class="serach-list">预计交车时间:{{SearchappendList.expectLeave|sDatetime}}</div>
      <div class="serach-list">行驶里程(KM):{{SearchappendList.mileage}}</div>
      <div class="serach-list">上次进店时间:{{SearchappendList.lastEnterDate|sDatetime}}</div>
    </div>
    <div class="serach-main">
      <div class="serach-list">维修工位:{{SearchappendList.location}}</div>
      <div class="serach-list">建议下次保养日期:{{SearchappendList.nextDate}}</div>
      <div class="serach-list">建议下次保养里程(KM):{{SearchappendList.nextMileage}}</div>
      <div class="serach-list">上次进店里程(KM):{{SearchappendList.lastMileage}}</div>
    </div>

    <div [hidden]="!isShowAppend">
      <tabset #staticTabs>
        <!--维修项目-->
        <tab heading="维修项目">


          <table class="table  table-striped table-bordered">
            <thead>
              <tr>
                <th>操作</th>
                <th>维修项目名称</th>
                <th>维修工时(小时)</th>
                <th>工时单价(元)</th>
                <th>折扣率(%)</th>
                <th>金额(元)</th>
                <th>操作时间</th>

              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let item of maintenanceProjectData">
                <td>&nbsp;</td>
                <td>{{item.serviceName}}<span [class.append-stamp]="item.type === 3">增项</span></td> 
                <td>{{item.workHour}}</td>
                <td>{{item.price|centToYuan}}</td>
                <td>{{item.discount}}</td>
                <td>{{item.amount|centToYuan}}</td>
                <td>{{item.operateDateTime|sDatetime}}</td>
              </tr>

              <tr *ngFor="let item of newMaintenanceItemData">
                <td width="40">
                  <button class="btn btn-sm btn-success mr-2" (click)="onMaintenanceItemEdit($event, addModal, item)">编辑</button>
                  <button class="btn btn-sm btn-danger mr-2" (click)="$event.preventDefault();onDelMaintenanceItem(item?.serviceId)">删除</button>
                </td>
                <td>{{item?.serviceName}}</td>
                <td>{{item?.workHour}}</td>
                <td>{{item?.price|centToYuan}}</td>
                <td>{{item?.discount}}</td>
                <td>{{item?.amount|centToYuan}}</td>
                <td>{{item?.operationTime|sDatetime}}</td>
              </tr>
            </tbody>
          </table>
          <div>
            <button class="btn btn-sm btn-info mr-2" (click)="addModal.show()" placement="right">新增</button>
          </div>
        </tab>
        <!--附加项目-->
        <tab heading="附加项目">
          <table class='table   table-striped table-bordered'>
            <thead>
              <tr>
                <th>操作</th>
                <th>备注</th>
              </tr>
            </thead>
            <tr *ngFor="let item of attachServiceOutputs">
              <td></td>
              <td>{{item.description}}</td>
            </tr>
            <tr *ngFor="let item of newAttachData;let i=index">
              <td width="40">
                <button class="btn btn-sm btn-success mr-2" (click)="onAttachEdit($event, attachModal, item)">编辑</button>
                <button class="btn btn-sm btn-danger mr-2" (click)="$event.preventDefault();onDelAttachItem(i)">删除</button>
              </td>
              <td>{{item.description}}</td>
            </tr>
          </table>
          <div>
            <button class="btn btn-sm btn-info mr-2" [disabled]="!!((newAttachData?.length)>=1)" (click)="attachModal.show()" placement="right">新增</button>
          </div>
        </tab>

        <!--建议维修项-->
        <tab heading="建议维修项">
          <table class='table   table-striped table-bordered'>
            <thead>
              <tr>
                <th>操作</th>
                <th>建议维修项目</th>
                <th>操作时间</th>
                <th>备注</th>

              </tr>
            </thead>
            <tr *ngFor="let item of suggestServiceOutputs">
              <td></td>
              <td>{{item.content}}</td>
              <td>{{item.operateDateTime|sDatetime}}</td>
              <td>{{item.description}}</td>

            </tr>
            <tr *ngFor="let item of newSuggestData">
              <td width="40">
                <button class="btn btn-sm btn-success mr-2" (click)="onSuggestItemEdit($event, suggestModal, item)">编辑</button>
                <button class="btn btn-sm btn-danger mr-2" (click)="$event.preventDefault();onDelSuggestItem(item.serviceId)">删除</button>
              </td>
              <td>{{item.serviceName}}</td>
              <td>{{item.operationTime|sDatetime}}</td>
              <td>{{item.description}}</td>

            </tr>

          </table>
          <div>
            <button class="btn btn-sm btn-info mr-2" (click)="suggestModal.show()" placement="right">新增</button>
          </div>
        </tab>

        <!--上次维修记录-->
        <tab heading="上次维修记录" *ngIf="lastManufactureDetailOutput">
          <table class="table table-striped table-bordered">
            <caption>维修项目</caption>
            <thead>
              <tr>
                <th>项目名称</th>
                <th>维修工时(小时)</th>
                <th>工时单价(元)</th>
                <th>金额(元)</th>
                <th>折扣率(100%)</th>
                <th>操作时间</th>

              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let item of lastDataProjectList ">
                <td>{{item.serviceName}}<span [class.append-stamp]="item.type === 3">增项</span></td>
                <td>{{item.workHour}}</td>
                <td>{{item.price|centToYuan}}</td>
                <td>{{item.amount|centToYuan}}</td>
                <td>{{item.discount}}</td>
                <td>{{item.operateDateTime|sDatetime}}</td>

              </tr>
            </tbody>
          </table>
          <table class="table table-striped table-bordered">
            <caption>维修配件</caption>
            <thead>
              <tr>
                <th>维修工项</th>
                <th>配件名称</th>
                <th>品牌</th>
                <th>规格型号</th>
                <th>数量(个)</th>
                <th>单价(元)</th>
                <th>金额(元)</th>
                <th>操作时间</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let item of lastRepairList">
                <td>{{item.serviceName}}</td>
                <td>{{item.productName}}</td>
                <td>{{item.brandName}}</td>
                <td>{{item.specification}}</td>
                <td>{{item.count}}</td>
                <td>{{item.price|centToYuan}}</td>
                <td>{{item.amount|centToYuan}}</td>
                <td>{{item.operateDateTime|sDatetime}}</td>
              </tr>
            </tbody>
          </table>

          <table class="table  table-striped table-bordered">
            <caption>附加项目</caption>
            <thead>
              <tr>
                <th>备注</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let item of lastAddList">
                <td>{{item.description}}</td>
              </tr>
            </tbody>
          </table>

          <table class="table  table-striped table-bordered">
            <caption>建议维修项目</caption>
            <thead>
              <tr>
                <th>建议维修项目</th>
                <th>操作时间</th>
                <th>备注</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let item of lastSuggestList">
                <td>{{item.content}}</td>
                <td>{{item.operateDateTime|sDatetime}}</td>
                <td>{{item.description}}</td>
              </tr>
            </tbody>
          </table>
        </tab>
      </tabset>

      <div class="card" style="margin-top:40px;">
        <div class="card-header" style="font-size:smaller;color:gray;padding: 3px 5px;">
          工时费：<span class="ml-2 mr-2">{{workHourFee|centToYuan}}元</span> | 材料费：
          <span class="ml-2 mr-2">{{materialFee|centToYuan}}元</span> | 其它：
          <span class="ml-2 mr-2">{{otherFee|centToYuan}}元</span> | 应收金额：
          <span class="ml-2 mr-2">{{(workHourFee+materialFee+otherFee)|centToYuan}}元</span>| 折扣金额：
          <span class="ml-2 mr-2">{{(workHourFee-sumFee)|centToYuan}}元</span>
        </div>
      </div>

    </div>

  </div>
  <div class="card-footer text-muted">
    <button type="button" class="btn  btn-primary" [disabled]="!isableAppend" (click)="submitAddOrder()">提交增项</button>
    <button type="button" class="btn  btn-success" [disabled]="!isableSuspend" (click)="suspend()">挂单</button>
  </div>

</div>

<div bsModal #addModal="bs-modal" class="modal" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true">
  <!--每次都创建一个新的 为了清空表单-->
  <div *ngIf="addModal.isShown" class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h6 class="modal-title pull-left">新增维修项目</h6>
        <button type="button" class="close pull-right" (click)="addModal.hide();selectedItem=null;" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <hq-add-maintenance-item [services]="selectedServices" [item]="selectedItem" (onCancel)="addModal.hide();selectedItem=null;"
          (onConfirm)="onConfirmNewMaintenanceItem($event, addModal)"></hq-add-maintenance-item>
      </div>
    </div>
  </div>
</div>

<div bsModal #attachModal="bs-modal" class="modal" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true">
  <!--每次都创建一个新的 为了清空表单-->
  <div *ngIf="attachModal.isShown" class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h6 class="modal-title pull-left">新增附加项目</h6>
        <button type="button" class="close pull-right" (click)="attachModal.hide();selectedAttachItem=null;" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <hq-add-attach-item (onCancel)="attachModal.hide();selectedAttachItem=null" [item]="selectedAttachItem" (formSubmit)="onCreateAttach($event)"></hq-add-attach-item>
      </div>
    </div>
  </div>
</div>

<div bsModal #suggestModal="bs-modal" class="modal" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true">
  <!--每次都创建一个新的 为了清空表单-->
  <div *ngIf="suggestModal.isShown" class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h6 class="modal-title pull-left">新增建议维修项目</h6>
        <button type="button" class="close pull-right" (click)="suggestModal.hide();selectedSuggestItem=null;" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">

        <hq-add-suggest-item [services]="selectedSuggestServices" [item]="selectedSuggestItem" (onCancel)="suggestModal.hide();selectedSuggestItem=null;"
          (onConfirm)="onConfirmNewSuggestItem($event, suggestModal)"></hq-add-suggest-item>
      </div>
    </div>
  </div>
</div>