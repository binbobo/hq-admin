<ng-template hq-alerter></ng-template>
<div class="card business">
  <div class="card-header">维修历史</div>
  <div class="card-block">
    <form (ngSubmit)="onSearch()" class="form-inline mb-2">
        <div class="input-group m-1">
          <span class="input-group-addon">进店时间</span>
          <input [max-date]="maxEnterStartDate" [(ngModel)]="params.enterStartTimeDate" class="form-control" id="enterStartTimeDate"
            name="enterStartTimeDate" date-only="true" type="text" ngui-datetime-picker placeholder="请输入开始日期"/>
          <span class="input-group-addon">-</span>
          <input [min-date]="minEnterEndDate" [max-date]="maxEnterEndDate" [(ngModel)]="params.enterEndTimeDate" class="form-control"
            id="enterEndTimeDate" name="enterEndTimeDate" date-only="true" type="text" ngui-datetime-picker placeholder="请输入截止日期"/>
        </div>
        <div class="input-group m-1">
          <span class="input-group-addon">出厂时间</span>
            <input [max-date]="maxLeaveStartDate" [(ngModel)]="params.leaveStartTimeDate" class="form-control" id="leaveStartTimeDate"
              name="leaveStartTimeDate" date-only="true" type="text" ngui-datetime-picker placeholder="请输入开始日期"/>
          <span class="input-group-addon">-</span>
            <input [min-date]="minLeaveEndDate" [max-date]="maxLeaveEndDate" [(ngModel)]="params.leaveEndTimeDate" class="form-control"
              id="leaveEndTimeDate" name="leaveEndTimeDate" date-only="true" type="text" ngui-datetime-picker placeholder="请输入截止日期"/>
        </div>
        <div class="input-group m-1">
          <span class="input-group-addon">车牌号</span>
          <input [(ngModel)]="params.plateNo" hqPlateNoTypeahead class="form-control" name="plateNo" id="plateNo" type="text" placeholder="请输入车牌号"
          />
        </div>
        <div class="input-group m-1">
          <span class="input-group-addon">服务顾问</span>
          <div class="hq-col">
            <ngx-dropdown-treeview [config]="nameConfig" [items]="nameItems" (selectedChange)="onSearchNameChange($event)">
            </ngx-dropdown-treeview>
          </div>
        </div>
        <div class="input-group m-1">
          <span *ngIf="items" for="searchRange" class="input-group-addon">查询范围</span>
          <div *ngIf="items" class="hq-col">
            <ngx-dropdown-treeview [config]="config" [items]="items" (selectedChange)="onSearchRangeChange($event)">
            </ngx-dropdown-treeview>
          </div>
        </div>
        <div class="input-group m-1">
            <button type="submit" class="btn btn-primary">查询</button>
        </div>
    </form>
    <hr *ngIf="isSearch">
    <h5 *ngIf="isShow1">温馨提示：系统找到该车辆在本店维修过<span class="color">{{total}}</span>次。</h5>
    <h5 *ngIf="isShow2">温馨提示：系统未找到该车辆的历史数据，请重新检索车牌号查询。</h5>
    <hr *ngIf="isSearch">
    <div class="table-container">
      <table class="table table-bordered">
        <thead>
          <tr>
            <th>操作</th>
            <th *ngIf="items">店名</th>
            <th>车牌号</th>
            <th>工单号</th>
            <th>维修类型</th>
            <th>进厂时间</th>
            <th>出厂时间</th>
            <th>超时</th>
            <th>车型</th>
            <th>VIN</th>
            <th>送修人</th>
            <th>送修人电话</th>
            <th>维修技师</th>
            <th>服务顾问</th>
            <th>金额（元）</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let item of list" class="text-center">
            <td width="75">
              <button [hqSpinner]="item.generating" [disabled]="item.generating" type="button" class="btn btn-primary btn-sm" (click)="businessDetailsHandler(item, item.id)">详情</button>
            </td>
            <td *ngIf="items">{{item.orgName}}</td>
            <td>{{item.plateNo}}</td>
            <td>{{item.billCode}}</td>
            <td>{{item.typeName}}</td>
            <td>{{item.createdOnUtc|date:"yyyy/MM/dd HH:mm:ss"}}</td>
            <td>{{item.leaveTime|date:"yyyy/MM/dd HH:mm:ss"}}</td>
            <td [class.overtime]="item.overTime">{{item.overTime|durationHumanize}}</td>
            <td>{{item.vehicleName}}</td>
            <td>{{item.vin}}</td>
            <td>{{item.contactUser}}</td>
            <td>{{item.contactInfo}}</td>
            <td>{{item.employeeNames}}</td>
            <td>{{item.createdUserName}}</td>
            <td>{{item.checkoutedAmount|centToYuan}}</td>
          </tr>
        </tbody>
        <tfoot *ngIf="list?.length <= 0">
          <tr>
            <td colspan="19">查询结果为空</td>
          </tr>
        </tfoot>
      </table>
    </div>
    <hq-pagination [loading]="loading" [totalItems]="total" [(currentPage)]="index" (pageChanged)="onPageChanged($event)"></hq-pagination>
  </div>
  <div class="card-footer">
    <button type="button" (click)="onExport()" class="btn btn-export">导出</button>
  </div>
</div>

<hq-print-view *ngIf="businessData" class="invisible" hqPrint #printer="hq-print" [businessData]="businessData"></hq-print-view>

<!--详情弹框-->
<div class="modal fade" bsModal #bdModal="bs-modal" tabindex="-1" role="dialog">
  <div *ngIf="bdModal.isShown" class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <p class="modal-title">维修历史</p>
        <button class="close pull-right" (click)="bdModal.hide()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="card">
          <!--<div class="card-block">-->
            <!--<hr>
            <div class="row">
              <div class="col-4">
                <label>车牌号: </label>
                <span>{{businessData?.plateNo}}</span>
              </div>
              <div class="col-4">
                <label>车型描述: </label>
                <span>{{businessData?.model}}</span>
              </div>
              <div class="col-4">
                <label>VIN: </label>
                <span>{{businessData?.vin}}</span>
              </div>
            </div>
            <div class="row">
              <div class="col-4">
                <label>送修人: </label>
                <span>{{businessData?.contactUser}}</span>
              </div>
              <div class="col-4">
                <label>送修人手机: </label>
                <span>{{businessData?.contactInfo}}</span>
              </div>
              <div class="col-4">
                <label>结算单号: </label>
                <span>{{businessData?.settlementCode}}</span>
              </div>
            </div>
            <div class="row">
              <div class="col-4">
                <label>工单号: </label>
                <span>{{businessData?.billCode}}</span>
              </div>
              <div class="col-4">
                <label>结算员: </label>
                <span>{{businessData?.updateUser}}</span>
              </div>
              <div class="col-4">
                <label>结算时间: </label>
                <span>{{businessData?.updateOnUtc|date:"yyyy/MM/dd HH:mm:ss"}}</span>
              </div>
            </div>
            <div class="row">
              <div class="col-4">
                <label>结算方: </label>
                <span>{{businessData?.settlementParty}}</span>
              </div>
              <div class="col-4">
                <label>服务顾问: </label>
                <span>{{businessData?.createdUserName}}</span>
              </div>
            </div>
            <hr>
            <div class="row">
              <div class="col-4">
                <label>维修类型: </label>
                <span>{{businessData?.typeName}}</span>
              </div>
              <div class="col-4">
                <label>进店时间: </label>
                <span>{{businessData?.createdOnUtc|date:"yyyy/MM/dd HH:mm:ss"}}</span>
              </div>
              <div class="col-4">
                <label>进店里程: </label>
                <span>{{businessData?.mileage}}</span>
                <span class="ml-2" *ngIf="businessData.mileage">KM</span>
              </div>
            </div>
            <div class="row">
              <div class="col-4">
                <label>出厂时间: </label>
                <span>{{businessData?.updateOnUtc|date:"yyyy/MM/dd HH:mm:ss"}}</span>
              </div>
              <div class="col-4">
                <label>出厂里程: </label>
                <span>{{businessData?.leaveMileage}}</span>
                <span class="ml-2" *ngIf="businessData.leaveMileage">KM</span>
              </div>
            </div>
            <hr>-->
            <table class="table table-order-info table-bordered">
              <tbody>
                <tr>
                  <td>车牌号</td>
                  <td>{{businessData?.plateNo}}</td>
                  <td>车型描述</td>
                  <td>{{businessData?.model}}</td>
                </tr>
                <tr>
                  <td>维修类型</td>
                  <td>{{businessData?.typeName}}</td>
                  <td>VIN</td>
                  <td>{{businessData?.vin}}</td>
                </tr>
                <tr>
                  <td>送修人</td>
                  <td>{{businessData?.contactUser}}</td>
                  <td>送修人手机</td>
                  <td>{{businessData?.contactInfo}}</td>
                </tr>
                <tr>
                  <td>服务顾问</td>
                  <td>{{businessData?.createdUserName}}</td>
                  <td>工单号</td>
                  <td>{{businessData?.billCode}}</td>
                </tr>
                <tr>
                  <td>结算员</td>
                  <td>{{businessData?.updateUser}}</td>
                  <td>结算单号</td>
                  <td>{{businessData?.settlementCode}}</td>
                </tr>
                <tr>
                  <td>结算方</td>
                  <td>{{businessData?.settlementParty}}</td>
                  <td>结算时间</td>
                  <td>{{businessData?.updateOnUtc|date:"yyyy/MM/dd HH:mm:ss"}}</td>
                </tr>
                <tr>
                  <td>进店里程</td>
                  <td>{{businessData?.mileage}} km</td>
                  <td>进店时间</td>
                  <td>{{businessData?.createdOnUtc|date:"yyyy/MM/dd HH:mm:ss"}}</td>
                </tr>
                <tr>
                  <td>出厂里程</td>
                  <td>{{businessData?.leaveMileage}} km</td>
                  <td>出厂时间</td>
                  <td>{{businessData?.updateOnUtc|date:"yyyy/MM/dd HH:mm:ss"}}</td>
                </tr>
              </tbody>
            </table>
          <!--</div>-->
          <div class="card-block">
            <table class="table table-bordered">
              <caption>收费结算单</caption>
              <thead>
                <tr>
                  <th width="50">序号</th>
                  <th>名称</th>
                  <th>金额（元）</th>
                  <th>备注</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let item of businessData?.totalCost;let index=index">
                  <td>{{index+1}}</td>
                  <td>{{item.name}}</td>
                  <td>{{item.receivableCost|centToYuan}}</td>
                  <td>{{item.description}}</td>
                </tr>
              </tbody>
            </table>
            <div class="row">
              <div class="col-4">
                <label>金额合计：</label>
                <span>{{moneyObj?.amountReceivable1|centToYuan}}</span>
              </div>
              <div class="col-4">
                <label>优惠：</label>
                <span>{{moneyObj?.discountMoney1|centToYuan}}</span>
              </div>
              <div class="col-4">
                <label>应收金额：</label>
                <span>{{businessData?.actualAmount|centToYuan}}</span>
              </div>
            </div>
          </div>
          <br>
          <div class="card-block">
            <table class="table table-bordered">
              <caption>附录一：工时明细</caption>
              <thead>
                <tr>
                  <th width="50">序号</th>
                  <th>维修项目</th>
                  <th>结算工时</th>
                  <th>单价（元/工时）</th>
                  <th>折扣率(%)</th>
                  <th>金额（元）</th>
                  <th>备注</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let item of businessData?.workHours;let index=index">
                  <td>{{index+1}}</td>
                  <td>{{item.serviceName}}</td>
                  <td>{{item.workHour}}</td>
                  <td>{{item.price|centToYuan}}</td>
                  <td>{{item.discount}}</td>
                  <td>{{item.amount|centToYuan}}</td>
                  <td>{{item.description}}</td>
                </tr>
              </tbody>
            </table>
            <div class="row">
              <div class="col-4">
                <label>金额合计：</label>
                <span>{{moneyObj?.amountReceivable2|centToYuan}}</span>
              </div>
              <div class="col-4">
                <label>优惠：</label>
                <span>{{moneyObj?.discountMoney2|centToYuan}}</span>
              </div>
              <div class="col-4">
                <label>应收金额：</label>
                <span>{{moneyObj?.countMoney2|centToYuan}}</span>
              </div>
            </div>
          </div>
          <br>
          <div class="card-block">
            <table class="table table-bordered">
              <caption>附录三：材料明细</caption>
              <thead>
                <tr>
                  <th width="50">序号</th>
                  <th>配件名称</th>
                  <th>单价（元）</th>
                  <th>数量</th>
                  <th>金额（元）</th>
                  <th>备注</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let item of businessData?.matereialDetails;let index=index">
                  <td>{{index+1}}</td>
                  <td>{{item.productName}}</td>
                  <td>{{item.price|centToYuan}}</td>
                  <td>{{item.count}}</td>
                  <td>{{item.amount|centToYuan}}</td>
                  <td>{{item.description}}</td>
                </tr>
              </tbody>
            </table>
            <div class="row">
              <div class="col-4">
                <!--<label>合计：</label>-->
              </div>
              <div class="col-4">
                <!--<label>合计：</label>-->
              </div>
              <div class="col-4">
                <label>应收金额：</label>
                <span>{{moneyObj?.amountReceivable3|centToYuan}}</span>
              </div>
            </div>
          </div>
          <br>
          <div *ngIf="businessData?.appendItems.length" class="card-block">
            <table class="table table-bordered">
              <caption>附录四：附加项目</caption>
              <thead>
                <tr>
                  <th width="50">序号</th>
                  <th>项目内容</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let item of businessData?.appendItems;let index=index">
                  <td>{{index+1}}</td>
                  <td>{{item.name}}</td>
                </tr>
              </tbody>
            </table>
          </div>
          <br>
          <div *ngIf="businessData?.adviceItems.length" class="card-block">
            <table class="table table-bordered">
              <caption>附录五：建议维修项</caption>
              <thead>
                <tr>
                  <th width="50">序号</th>
                  <th>建议维修项目</th>
                  <th>备注</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let item of businessData?.adviceItems;let index=index">
                  <td>{{index+1}}</td>
                  <td>{{item.content}}</td>
                  <td>{{item.description}}</td>
                </tr>
              </tbody>
            </table>
          </div>
          <br>
          <div class="card-footer text-center">
            <button (click)="print()" type="button" class="btn btn-export">打印</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>