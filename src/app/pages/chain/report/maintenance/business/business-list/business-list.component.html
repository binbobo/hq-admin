<ng-template hq-alerter></ng-template>
<div class="card business">
  <div class="card-header">维修历史</div>
  <div class="card-block">
    <form [formGroup]="businessForm" (ngSubmit)="onSearch()">
      <div class="form-group row">
        <label for="plateNo" class="col-form-label margin-l">车牌号：</label>
        <div class="col-2">
          <input [(ngModel)]="params.plateNo" formControlName="plateNo" [hqTableTypeahead]="plateNotypeaheadSource" [columns]="typeaheadColumns"
            (onSelect)="plateNoOnSelect($event)" class="form-control" id="plateNo" type="text" placeholder="请输入车牌号" />
        </div>
        <label for="enterTime" class="col-form-label margin-l">进店时间：</label>
        <div class="col-3">
          <input [close-on-select]="false" [(ngModel)]="params.enterStartTimeDate" formControlName="enterStartTimeDate" class="form-control datetime-picker"
            id="enterStartTimeDate" type="text" ngui-datetime-picker/>
        </div>
        <label class="col-form-label">至：</label>
        <div class="col-3">
          <input [close-on-select]="false" [(ngModel)]="params.enterEndTimeDate" formControlName="enterEndTimeDate" class="form-control datetime-picker"
            id="enterEndTimeDate" type="text" ngui-datetime-picker/>
        </div>
      </div>
      <div class="form-group row">
        <label for="leaveTime" class="col-form-label margin-l">出厂时间：</label>
        <div class="col-3">
          <input [close-on-select]="false" [(ngModel)]="params.leaveStartTimeDate" formControlName="leaveStartTimeDate" class="form-control datetime-picker"
            id="leaveStartTimeDate" type="text" ngui-datetime-picker/>
        </div>
        <label class="col-form-label">至：</label>
        <div class="col-3">
          <input [close-on-select]="false" [(ngModel)]="params.leaveEndTimeDate" formControlName="leaveEndTimeDate" class="form-control datetime-picker"
            id="leaveEndTimeDate" type="text" ngui-datetime-picker/>
        </div>
        <label *ngIf="items" for="searchRange" class="col-form-label">查询范围</label>
        <div *ngIf="items" class="col-2">
          <ngx-dropdown-treeview [config]="config" [items]="items" (selectedChange)="onSearchRangeChange($event)">
          </ngx-dropdown-treeview>
        </div>
        <!--<label *ngIf="isShow" for="orgName" class="col-form-label margin-l">查询范围：</label>
        <select *ngIf="isShow" name="orgName" id="orgName" class="form-control col-2">
            <option value="1">总店的</option>
          </select>-->
        <div class="col-1">
          <button type="submit" class="btn btn-primary">查询</button>
        </div>
      </div>
    </form>
    <hr>
    <h5 *ngIf="isSearch">温馨提示：系统找到该车辆在本店维修过<span class="color">{{total}}</span>次</h5>
    <hr>
    <div class="overflow-auto">
      <table class="table table-striped table-bordered">
        <thead>
          <tr>
            <th>操作</th>
            <th *ngIf="items">店名</th>
            <th>车牌号</th>
            <th>工单号</th>
            <th>维修类型</th>
            <!--<th>车主</th>-->
            <th>进厂时间</th>
            <th>预计交车时间</th>
            <th>超时</th>
            <th>车型</th>
            <th>VIN</th>
            <th>送修人</th>
            <th>送修人电话</th>
            <th>维修技师</th>
            <th>出厂时间</th>
            <th>服务顾问</th>
            <!--<th>品牌</th>
          <th>行驶里程</th>
          <th>购车时间</th>
          <th>介绍人</th>
          <th>介绍人电话</th>-->
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let item of list">
            <td width="75">
              <button [hqSpinner]="item.generating" [disabled]="item.generating" type="button" class="btn btn-info btn-sm" (click)="businessDetailsHandler(item, item.id, bdModal)">详情</button>
              <!--<a href="javascript:void(0)" (click)="businessDetailsHandler($event, item.id, bdModal)">详情</a>-->
            </td>
            <td *ngIf="items">{{item.orgName}}</td>
            <td>{{item.plateNo}}</td>
            <td>{{item.billCode}}</td>
            <td>{{item.typeName}}</td>
            <td>{{item.createdOnUtc|date:"yyyy/MM/dd HH:mm:ss"}}</td>
            <td>{{item.expectLeave|date:"yyyy/MM/dd HH:mm:ss"}}</td>
            <!--<td>{{item.customerName}}</td>-->
            <td class="red-color">{{item.overTime|durationHumanize}}</td>
            <td>{{item.vehicleName}}</td>
            <td>{{item.vin}}</td>
            <!--<td>{{item.brand}}</td>-->
            <!--<td>{{item.mileage}}</td>-->
            <!--<td>{{item.purchaseDate|date:"yyyy/MM/dd HH:mm:ss"}}</td>-->
            <td>{{item.contactUser}}</td>
            <td>{{item.contactInfo}}</td>
            <!--<td>{{item.introducer}}</td>
          <td>{{item.introPhone}}</td>-->
            <td>{{item.employeeNames}}</td>
            <td>{{item.leaveTime|date:"yyyy/MM/dd HH:mm:ss"}}</td>
            <td>{{item.createdUserName}}</td>
          </tr>
        </tbody>
        <tfoot *ngIf="list?.length <= 0">
          <tr>
            <td colspan="19">查询结果为空</td>
          </tr>
        </tfoot>
      </table>
    </div>
    <hq-pagination [loading]="loading" [totalItems]="total" [(currentPage)]="index" (pageChanged)="onPageChanged($event)"></hq-pagination>
  </div>
  <div class="card-footer">
    <button type="button" (click)="onExport()" class="btn btn-secondary">导出</button>
  </div>
</div>

<hq-print-view *ngIf="businessData" class="invisible" hqPrint #printer="hq-print" [businessData]="businessData"></hq-print-view>

<!--详情弹框-->
<div class="modal fade" bsModal #bdModal="bs-modal" tabindex="-1" role="dialog">
  <div *ngIf="bdModal.isShown" class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <p class="modal-title mg">维修历史</p>
        <button class="close pull-right" (click)="bdModal.hide()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="card">
          <div class="card-block clearborder">
            <hr>
            <div class="row">
              <div class="col-4">
                <label>车牌号: </label>
                <span>{{businessData?.plateNo}}</span>
              </div>
              <div class="col-4">
                <label>车型描述: </label>
                <span>{{businessData?.model}}</span>
              </div>
              <div class="col-4">
                <label>VIN: </label>
                <span>{{businessData?.vin}}</span>
              </div>
            </div>
            <div class="row">
              <div class="col-4">
                <label>送修人: </label>
                <span>{{businessData?.contactUser}}</span>
              </div>
              <div class="col-4">
                <label>送修人手机: </label>
                <span>{{businessData?.contactInfo}}</span>
              </div>
              <div class="col-4">
                <label>结算单号: </label>
                <span>{{businessData?.settlementCode}}</span>
              </div>
            </div>
            <div class="row">
              <div class="col-4">
                <label>工单号: </label>
                <span>{{businessData?.billCode}}</span>
              </div>
              <div class="col-4">
                <label>结算员: </label>
                <span>{{businessData?.updateUser}}</span>
              </div>
              <div class="col-4">
                <label>结算时间: </label>
                <span>{{businessData?.updateOnUtc|date:"yyyy/MM/dd HH:mm:ss"}}</span>
              </div>
            </div>
            <div class="row">
              <div class="col-4">
                <label>结算方: </label>
                <span>{{businessData?.settlementParty}}</span>
              </div>
              <div class="col-4">
                <label>服务顾问: </label>
                <span>{{businessData?.createdUserName}}</span>
              </div>
            </div>
            <hr>
            <div class="row">
              <div class="col-4">
                <label>维修类型: </label>
                <span>{{businessData?.typeName}}</span>
              </div>
              <div class="col-4">
                <label>进店时间: </label>
                <span>{{businessData?.createdOnUtc|date:"yyyy/MM/dd HH:mm:ss"}}</span>
              </div>
              <div class="col-4">
                <label>进店里程: </label>
                <span>{{businessData?.mileage}}</span>
                <span class="ml-2" *ngIf="businessData.mileage">KM</span>
              </div>
            </div>
            <div class="row">
              <div class="col-4">
                <label>出厂时间: </label>
                <span>{{businessData?.updateOnUtc|date:"yyyy/MM/dd HH:mm:ss"}}</span>
              </div>
              <div class="col-4">
                <label>出厂里程: </label>
                <span>{{businessData?.leaveMileage}}</span>
                <span class="ml-2" *ngIf="businessData.leaveMileage">KM</span>
              </div>
            </div>
            <hr>
          </div>
          <div class="card-block">
            <table class="table table-striped table-bordered">
              <caption>表一：收费结算单</caption>
              <thead>
                <tr>
                  <th width="50">序号</th>
                  <th>名称</th>
                  <th>金额</th>
                  <th>备注</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let item of businessData?.totalCost;let index=index">
                  <td>{{index+1}}</td>
                  <td>{{item.name}}</td>
                  <td>{{item.receivableCost|centToYuan}}</td>
                  <td>{{item.description}}</td>
                </tr>
              </tbody>
            </table>
            <div class="row">
              <div class="col-3">
                <label>合计：</label>
              </div>
              <div class="col-3">
                <label>应收金额：</label>
                <span>{{moneyObj?.amountReceivable1|centToYuan}}</span>
              </div>
              <div class="col-3">
                <label>折扣金额：</label>
                <span>{{moneyObj?.discountMoney1|centToYuan}}</span>
              </div>
              <div class="col-3">
                <label>实收金额：</label>
                <span>{{businessData?.actualAmount|centToYuan}}</span>
              </div>
            </div>
          </div>
          <br>
          <div class="card-block">
            <table class="table table-striped table-bordered">
              <caption>表二：工时明细</caption>
              <thead>
                <tr>
                  <th width="50">序号</th>
                  <th>维修项目</th>
                  <th>结算工时</th>
                  <th>单价（元/工时）</th>
                  <th>折扣率(%)</th>
                  <th>金额</th>
                  <th>备注</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let item of businessData?.workHours;let index=index">
                  <td>{{index+1}}</td>
                  <td>{{item.serviceName}}</td>
                  <td>{{item.workHour}}</td>
                  <td>{{item.price|centToYuan}}</td>
                  <td>{{item.discount}}</td>
                  <td>{{item.amount|centToYuan}}</td>
                  <td>{{item.description}}</td>
                </tr>
              </tbody>
            </table>
            <div class="row">
              <div class="col-4">
                <label>合计：</label>
              </div>
              <div class="col-4">
                <label>工时合计：</label>
                <span>{{moneyObj?.amountReceivable2|centToYuan}}</span>
              </div>
              <div class="col-4">
                <label>折扣金额：</label>
                <span>{{moneyObj?.discountMoney2|centToYuan}}</span>
              </div>
            </div>
          </div>
          <br>
          <div class="card-block">
            <table class="table table-striped table-bordered">
              <caption>表三：配件明细</caption>
              <thead>
                <tr>
                  <th width="50">序号</th>
                  <!--<th>维修项目</th>
                  <th>品牌</th>
                  <th>配件编码</th>-->
                  <th>配件名称</th>
                  <!--<th>规格型号</th>-->
                  <th>单位</th>
                  <th>数量</th>
                  <th>单价（元/个）</th>
                  <th>金额</th>
                  <th>备注</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let item of businessData?.matereialDetails;let index=index">
                  <td>{{index+1}}</td>
                  <!--<td>{{index+1}}</td>
                  <td>{{index+1}}</td>
                  <td>{{index+1}}</td>-->
                  <td>{{item.productName}}</td>
                  <!--<td>{{item.productName}}</td>-->
                  <td>{{item.unit}}</td>
                  <td>{{item.count}}</td>
                  <td>{{item.price|centToYuan}}</td>
                  <td>{{item.amount|centToYuan}}</td>
                  <td>{{item.description}}</td>
                </tr>
              </tbody>
            </table>
            <div class="row">
              <div class="col-4">
                <label>合计：</label>
              </div>
              <div class="col-4">
                <label>配件合计：</label>
                <span>{{moneyObj?.amountReceivable3|centToYuan}}</span>
              </div>
            </div>
          </div>
          <br>
          <div *ngIf="businessData?.appendItems.length" class="card-block">
            <table class="table table-striped table-bordered">
              <caption>表四：附加项目</caption>
              <thead>
                <tr>
                  <th width="50">序号</th>
                  <th>项目内容</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let item of businessData?.appendItems;let index=index">
                  <td>{{index+1}}</td>
                  <td>{{item.name}}</td>
                </tr>
              </tbody>
            </table>
          </div>
          <br>
          <div *ngIf="businessData?.adviceItems.length" class="card-block">
            <table class="table table-striped table-bordered">
              <caption>表五：建议维修项</caption>
              <thead>
                <tr>
                  <th width="50">序号</th>
                  <th>建议维修项目</th>
                  <th>备注</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let item of businessData?.adviceItems;let index=index">
                  <td>{{index+1}}</td>
                  <td>{{item.content}}</td>
                  <td>{{item.description}}</td>
                </tr>
              </tbody>
            </table>
          </div>
          <br>
          <div class="card-footer text-center">
            <button (click)="print()" type="button" class="btn btn-primary">打印</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>